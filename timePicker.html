<html>
<head>
<script src="jquery-3.7.1.min.js"></script>
	<!--<script src="script.js"></script> -->
	<script>
		
		const bookings = [{'start': "2025-05-12 10:00",'end': "2025-05-12 11:00",'id':12,'user':'james'},
		{'start': "2025-06-06 14:00",'end': "2025-06-06 15:00",'id':16,'user':'Cowboy Joe'}];

        $("#booking_list_view").hide();

        function timePicker(interval){
  
            const now = new Date();
	    	let DD = now.getDate();
    		let YY = now.getFullYear();
	    	let MM = now.getMonth();

            const todayDD = now.getDate();
    		const todayYY = now.getFullYear();
	    	const todayMM = now.getMonth();

            const freeColor = "#3333ff";
            const selectedColor = "#33FF33";
            const takenColor = "#FF3333";
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

            let time_slots = [];

            $("#pick_date_btn").html(DD + "/" + (MM + 1) + "/" + YY);
            $("#small_calendar_wrapper").hide();
            $("#booking_list_view").hide();

            let interval_list = [];
            
            function createBookingList()
            {
                time_slots = [];

                $(".time_slot").each(function() {
                    const selected = $(this).data("selected");
                    const time = $(this).data("time");
                    
                    if(selected==true){
                        time_slots.push(time);
                    }    
                })

                console.log(time_slots);
            }
            
            function createTimeView()
            {
                $("#time_line").html("");
                $("#time_slots").html("");

                for(let i=0; i < 24; i++)
                {
                    const hour = String(i).padStart(2, '0');
                    $("#time_line").append("<div class='time_indicator'><div>" + hour + ":00" + "</div></div>");
                    $("#time_line").append("<div class='time_indicator'><div>-</div></div>");
                                    
                }
                
                const max_slots = 1440/interval;
                for(let i=0; i < max_slots; i++)
                {
                    let color = freeColor;
                    
                    const startTime = timeConverter(i * interval);
                    const endTime = timeConverter((i + 1) * interval);
                    
                    let HHMM = startTime.split(":");

                    const booking = checkDate(YY,MM,DD,HHMM[0],HHMM[1]);
                    
                    const timeVal = YY + "-" + String(MM + 1).padStart(2,"0") + "-" + String(DD).padStart(2,"0") + " " + startTime;
                    
                    if(booking.length > 0)
                    {
                        color = takenColor;
                    }

                    for(selected_date of time_slots)
                    {
                        if(selected_date==timeVal)
                        {
                            color = selectedColor;
                        }
                    }

                    const text = startTime + " - " + endTime;
                    $("#time_slots").append("<div style='height:" + interval + "px; background:" + color + 
					"' class='time_slot' data-selected='false' data-time='" + timeVal +"'>" + text + "</div>");
                }
            }

            function checkDate(year,month,day,hour,min)
            {
                booking_detail = [];
                for(booking of bookings)
                {
                    const bookingYY = booking.start.substring(0,4);
                    const bookingMM = booking.start.substring(5,7);
                    const bookingDD = booking.start.substring(8,10);
                    const bookingHH = booking.start.substring(11,13); 
                    const bookingMin = booking.start.substring(14,16); 
                    
                    if(checkSum(bookingYY,bookingMM,bookingDD) == checkSum(YY,(MM + 1),DD) && hour==bookingHH && min==bookingMin)
                    {
                        booking_detail.push(booking.user);
                        booking_detail.push(booking.id);
                    }
                }
                return booking_detail;
            }
            
            function initCalendar()
            {
                $("#small_cal_month_viewer").text(monthNames[MM] + " - " + YY);
                $("#small_cal_month_picker").html(generateMonth(MM, YY));
            }

            function timeConverter(min)
            {
                const HH = parseInt(min / 60);
                const MM = min - (HH * 60);
                const result = String(HH).padStart(2, '0') + ":" + String(MM).padStart(2, '0');
                
                return result;
            }

            function checkSum(year,month,day)
			{
				return parseInt(String(year) + String(month).padStart(2, '0') + String(day).padStart(2, '0'));
			}

            function generateMonth(month, year)
			{
				const lastDateInMonth = new Date(year, month + 1, 0).getDate();
				const firstDayInMonth = new Date(year, month, 0).getDay();
				let dayNumber = 1;
				let divElement = "";

				for(let i=1; i < 45; i++)
				{
					if(i > firstDayInMonth && dayNumber < lastDateInMonth + 1){

						let className = "smallDayPicker";
						
						if(checkSum(year, month, dayNumber) < checkSum(todayYY,todayMM,todayDD))
						{
							className = "smallGreyedOut"
						}

						divElement += "<div class='" + className + "' ";
						divElement += "data-d='" +  dayNumber + "' ";
						divElement += "data-m='" +  month + "' ";
						divElement += "data-y='" +  year + "' ";
                        divElement += ">" + dayNumber + "</div>";
						dayNumber += 1;
					}else{
						divElement += "<div class='smallDayPickerEmty'></div>";
					}
					if(i % 7 == 0){
						divElement += "<div class='break'></div>";
					}
				}
				return divElement;
			}
            

            function prettyTimeFormat(dateTime){
                const split = dateTime.split(" ");
                const date = split[0].split("-");
                const time = split[1].split(":");
                
                const endtime = timeConverter((parseInt(time[0]) * 60) + interval);
                return date[2] + "/" + date[1] + "/" +  date[0] + " " + split[1] + " - " + endtime;  

            }


			$(document).on("click", ".time_slot", function(){
				const selected = $(this).data("selected");
                
                if(selected==false)
                {
                    $(this).css({"background":selectedColor});
                    $(this).data("selected", true);
                
                }else{
                    $(this).css({"background":freeColor});
                    $(this).data("selected", false);
                }
                createBookingList();
            });
			
            $("#small_cal_prev").on("click", function(){
				MM -= 1;
				if(MM < 0)
				{
					YY -= 1;
					MM = 11;
				}
				initCalendar();
			});
			
			$("#small_cal_next").on("click", function(){
				MM += 1;
				if(MM > 11)
				{
					YY += 1;
					MM = 0;
				}
				initCalendar();
			});

            $("#pick_date_btn").on("click", function(){
                $("#small_calendar_wrapper").show();
                $("#pick_date_btn").hide();
                $("#schedu_box").hide();
                $("#view_time_list").hide();
                initCalendar();
            });
	
            $(document).on("click", ".smallDayPicker", function(){
				DD = $(this).data('d');
				MM = $(this).data('m');
				YY = $(this).data('y');


                $("#pick_date_btn").html(DD + "/" + (MM + 1) + "/" + YY);
                $("#small_calendar_wrapper").hide();
                $("#pick_date_btn").show();
                $("#schedu_box").show();
                $("#view_time_list").show();
                createTimeView();
            });

            $(document).on("click", "#back_time_picker", function(){
                $("#time_picker_cal").show();
                $("#schedu_box").show();
                $("#booking_list_view").hide();
            });

            $("#view_time_list").on("click", function(){
                $("#booking_list_view").html("");
                let html = "<div id='back_time_picker'>Back</div>";
                for(selected_date of time_slots)
                {
                    html += "<div class='booking_list_item'>" + prettyTimeFormat(selected_date) + "</div>"; 
                }
                $("#booking_list_view").html(html);

                $("#time_picker_cal").hide();
                $("#schedu_box").hide();
                $("#booking_list_view").show();
                
            });
            

            createTimeView();
        }
		
		$(document).ready(function() {
			timePicker(60);	
		});
		
	</script>
	<style>
		

	</style>
</head>
<body>

    
    
    
	
</body>
</html>